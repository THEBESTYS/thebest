<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>더베스트 어학원 - 인천 연수구의 영어 마을</title>
    <style>
        /* (기존 스타일 유지 - 동일) */
        :root {
            --primary: #3498db;
            --secondary: #e74c3c;
            --accent: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nanum Gothic', 'Malgun Gothic', sans-serif;
        }
        
        /* ... 나머지 스타일은 동일하게 유지 ... */
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase SDK 추가 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <!-- 로그인 모달 - Firebase 인증으로 변경 -->
    <div id="loginModal" class="modal-overlay">
        <div class="login-modal">
            <button class="modal-close" id="closeModalBtn">&times;</button>
            <h3>로그인</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">이메일 주소</label>
                    <input type="email" id="loginEmail" placeholder="이메일을 입력하세요" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">비밀번호</label>
                    <input type="password" id="loginPassword" placeholder="비밀번호를 입력하세요" required>
                </div>
                <div class="error-message" id="loginError">
                    이메일 또는 비밀번호가 올바르지 않습니다.
                </div>
                <button type="submit" class="login-btn">로그인</button>
                <button type="button" class="login-btn" onclick="showRegisterForm()" style="margin-top: 10px; background-color: var(--accent);">
                    회원가입
                </button>
            </form>
            
            <!-- 회원가입 폼 (처음에는 숨김) -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerName">이름</label>
                    <input type="text" id="registerName" placeholder="이름을 입력하세요" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">이메일 주소</label>
                    <input type="email" id="registerEmail" placeholder="이메일을 입력하세요" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">비밀번호 (최소 6자)</label>
                    <input type="password" id="registerPassword" placeholder="비밀번호를 입력하세요" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="registerPasswordConfirm">비밀번호 확인</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="비밀번호를 다시 입력하세요" required>
                </div>
                <div class="error-message" id="registerError" style="display: none;">
                    회원가입 중 오류가 발생했습니다.
                </div>
                <div class="success-message" id="registerSuccess" style="color: green; display: none;">
                    회원가입 성공! 로그인해주세요.
                </div>
                <button type="submit" class="login-btn">회원가입</button>
                <button type="button" class="login-btn" onclick="showLoginForm()" style="margin-top: 10px; background-color: #777;">
                    로그인 화면으로
                </button>
            </form>
            
            <div class="demo-credentials">
                <p><strong>테스트 계정 정보</strong></p>
                <p>이메일: test@test.com</p>
                <p>비밀번호: 123456</p>
            </div>
        </div>
    </div>

    <!-- 헤더 -->
    <header>
        <div class="container">
            <div class="logo-container">
                <div class="logo">
                    <img src="logo.png" alt="더베스트어학원 로고">
                    <div class="logo-text">
                        <span>THE BEST</span> 어학원
                    </div>
                </div>
                <nav>
                    <ul>
                        <li><a href="#schedule">일정</a></li>                        
                        <li><a href="mbti-counseling.html" style="background-color: rgba(255, 255, 255, 0.2);">MBTI 학습상담</a></li>
                        <li><a href="eoz.html">EOZ 소개</a></li>
                        <li><a href=" https://thebestys.github.io/EDS/" target="_blank">프로그램</a></li>                               
                        <li><a href="busking.html">버스킹</a></li>
                        <li><a href="#parents">학부모 참여</a></li>
                        
                        <!-- 접근 제한이 있는 메뉴들 -->
                        <li><a href="https://thebestys.github.io/memberadmin/" class="restricted-link" data-target="memberadmin">수강관리</a></li>
                        <li><a href="https://thebestys.github.io/reservation/" class="restricted-link" data-target="reservation">예약</a></li>
                        <li><a href="https://thebestys.github.io/payment/" class="restricted-link" data-target="payment">수강료</a></li>
                        
                        <li><a href="#contact">문의하기</a></li>                        
                        <li><a href="https://cafe.naver.com/thebestedu" target="_blank">공지사항</a></li>
                        <li><a href="https://m.blog.naver.com/jian112/223078136097" target="_blank">블로그</a></li>
                        
                        <!-- 로그인 상태에 따라 변경되는 메뉴 -->
                        <li><a href="#" id="userLoginLink">로그인</a></li>
                        <li><a href="https://thebestys.github.io/adminreservation/" target="_blank">admin</a></li>
                        <li><a href="#" id="adminLink">관리자</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- 나머지 HTML 내용은 동일하게 유지 -->
    <!-- 비디오 히어로 섹션 -->
    <section class="video-hero">
        <!-- ... 동일 ... -->
    </section>

    <!-- 1학기 일정 섹션 -->
    <section id="schedule" class="schedule">
        <!-- ... 동일 ... -->
    </section>

    <!-- 나머지 섹션들도 동일하게 유지 -->

    <script>
        // Firebase 설정 - login-57c14 프로젝트와 동일하게 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCLg04u_zdp27A8hKotF8DIZp5sH8vwFdE",
            authDomain: "login-57c14.firebaseapp.com",
            projectId: "login-57c14",
            storageBucket: "login-57c14.appspot.com",
            messagingSenderId: "568290041777",
            appId: "1:568290041777:web:6f70ed0ef606364856a2cc",
            measurementId: "G-H5KJ2R3LCK"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        
        // 전역 변수
        let currentUser = null;
        let pendingRedirectUrl = null;
        
        // DOM 요소
        const loginModal = document.getElementById('loginModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        const registerSuccess = document.getElementById('registerSuccess');
        const userLoginLink = document.getElementById('userLoginLink');
        const adminLink = document.getElementById('adminLink');
        const restrictedLinks = document.querySelectorAll('.restricted-link');
        
        // 페이지 로드 시 인증 상태 확인
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase 인증 상태 관찰자
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // 로그인 성공
                    currentUser = user;
                    updateUIForLoggedInUser();
                    
                    // 로그인 모달이 열려있으면 닫기
                    if (loginModal.style.display === 'flex') {
                        loginModal.style.display = 'none';
                    }
                    
                    // 대기 중인 리디렉션이 있으면 처리
                    if (pendingRedirectUrl) {
                        window.open(pendingRedirectUrl, '_blank');
                        pendingRedirectUrl = null;
                    }
                    
                    // 로그인 시간 저장
                    sessionStorage.setItem('userLoggedIn', 'true');
                    sessionStorage.setItem('userEmail', user.email);
                    sessionStorage.setItem('loginTime', new Date().getTime().toString());
                } else {
                    // 로그아웃 상태
                    currentUser = null;
                    updateUIForLoggedOutUser();
                    
                    // 세션 스토리지 정리
                    sessionStorage.removeItem('userLoggedIn');
                    sessionStorage.removeItem('userEmail');
                    sessionStorage.removeItem('loginTime');
                }
            });
            
            // 비디오 관련 설정 (기존 코드)
            setupVideoAutoplay();
            enforceVideoPlayback();
        });
        
        // 접근 제한 링크 클릭 이벤트
        restrictedLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (!currentUser) {
                    // 로그인되지 않았으면 로그인 모달 표시
                    pendingRedirectUrl = this.href;
                    showLoginModal();
                } else {
                    // 로그인되었으면 바로 이동
                    window.open(this.href, '_blank');
                }
            });
        });
        
        // 로그인 링크 클릭
        userLoginLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (currentUser) {
                // 로그아웃
                firebase.auth().signOut().then(() => {
                    alert('로그아웃되었습니다.');
                });
            } else {
                // 로그인 모달 표시
                showLoginModal();
            }
        });
        
        // 관리자 링크 클릭
        adminLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (currentUser) {
                // 관리자 페이지로 이동 (별도 권한 체크 필요시 추가)
                window.open('https://thebestys.github.io/admin-eduhome/', '_blank');
            } else {
                alert('로그인이 필요합니다.');
                showLoginModal();
            }
        });
        
        // 로그인 모달 표시
        function showLoginModal() {
            loginModal.style.display = 'flex';
            showLoginForm();
        }
        
        // 로그인 폼 표시
        function showLoginForm() {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            loginError.style.display = 'none';
            registerError.style.display = 'none';
            registerSuccess.style.display = 'none';
        }
        
        // 회원가입 폼 표시
        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            loginError.style.display = 'none';
            registerError.style.display = 'none';
            registerSuccess.style.display = 'none';
        }
        
        // 모달 닫기
        closeModalBtn.addEventListener('click', function() {
            loginModal.style.display = 'none';
        });
        
        loginModal.addEventListener('click', function(e) {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
                pendingRedirectUrl = null; // 대기 중인 리디렉션 초기화
            }
        });
        
        // 로그인 폼 제출
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // 로그인 성공 - onAuthStateChanged에서 처리
                    loginError.style.display = 'none';
                })
                .catch((error) => {
                    console.error('로그인 실패:', error);
                    loginError.style.display = 'block';
                    loginError.textContent = getFirebaseErrorMessage(error);
                });
        });
        
        // 회원가입 폼 제출
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            // 비밀번호 확인
            if (password !== passwordConfirm) {
                registerError.textContent = '비밀번호가 일치하지 않습니다.';
                registerError.style.display = 'block';
                return;
            }
            
            // Firebase 회원가입
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // 회원가입 성공
                    const user = userCredential.user;
                    
                    // 추가 사용자 정보 저장 (Firestore)
                    return firebase.firestore().collection('users').doc(user.uid).set({
                        name: name,
                        email: email,
                        role: 'student', // 기본 역할
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    // 회원가입 성공 메시지
                    registerSuccess.style.display = 'block';
                    registerError.style.display = 'none';
                    
                    // 2초 후 로그인 폼으로 전환
                    setTimeout(() => {
                        showLoginForm();
                        document.getElementById('loginEmail').value = email;
                        document.getElementById('loginPassword').value = password;
                    }, 2000);
                })
                .catch((error) => {
                    console.error('회원가입 실패:', error);
                    registerError.textContent = getFirebaseErrorMessage(error);
                    registerError.style.display = 'block';
                });
        });
        
        // UI 업데이트 함수
        function updateUIForLoggedInUser() {
            // 로그인 링크 텍스트 변경
            userLoginLink.innerHTML = '<i class="fas fa-user"></i> 로그아웃';
            userLoginLink.title = '로그아웃';
            
            // 환영 메시지 추가 (선택사항)
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            userInfo.innerHTML = `
                <span style="color: white; margin-left: 15px;">
                    <i class="fas fa-user-circle"></i> ${currentUser.email.split('@')[0]}님
                </span>
            `;
            
            // 헤더에 사용자 정보 추가 (기존에 없으면)
            if (!document.querySelector('.user-info')) {
                document.querySelector('.logo-container').appendChild(userInfo);
            }
        }
        
        function updateUIForLoggedOutUser() {
            // 로그인 링크 텍스트 변경
            userLoginLink.innerHTML = '<i class="fas fa-sign-in-alt"></i> 로그인';
            userLoginLink.title = '로그인';
            
            // 사용자 정보 제거
            const userInfo = document.querySelector('.user-info');
            if (userInfo) {
                userInfo.remove();
            }
        }
        
        // Firebase 에러 메시지 변환
        function getFirebaseErrorMessage(error) {
            switch(error.code) {
                case 'auth/invalid-email':
                    return '유효하지 않은 이메일 형식입니다.';
                case 'auth/user-disabled':
                    return '비활성화된 계정입니다.';
                case 'auth/user-not-found':
                    return '등록되지 않은 이메일입니다.';
                case 'auth/wrong-password':
                    return '잘못된 비밀번호입니다.';
                case 'auth/email-already-in-use':
                    return '이미 사용 중인 이메일입니다.';
                case 'auth/weak-password':
                    return '비밀번호는 최소 6자 이상이어야 합니다.';
                case 'auth/operation-not-allowed':
                    return '이메일/비밀번호 계정이 비활성화되어 있습니다.';
                case 'auth/too-many-requests':
                    return '너무 많은 시도가 있었습니다. 잠시 후 다시 시도해주세요.';
                default:
                    return '로그인 중 오류가 발생했습니다.';
            }
        }
        
        // 세션 만료 체크 (30분)
        function checkSessionExpiry() {
            const loginTime = sessionStorage.getItem('loginTime');
            if (loginTime) {
                const currentTime = new Date().getTime();
                const timeDiff = currentTime - parseInt(loginTime);
                const thirtyMinutes = 30 * 60 * 1000;
                
                if (timeDiff > thirtyMinutes) {
                    // 자동 로그아웃
                    firebase.auth().signOut();
                    alert('세션이 만료되어 자동 로그아웃되었습니다.');
                }
            }
        }
        
        // 5분마다 세션 만료 체크
        setInterval(checkSessionExpiry, 5 * 60 * 1000);
        
        // 기존 비디오 관련 함수들 (동일하게 유지)
        function setupVideoAutoplay() {
            const heroVideo = document.getElementById('heroVideo');
            const videoLoading = document.getElementById('videoLoading');
            
            if (heroVideo && videoLoading) {
                heroVideo.addEventListener('loadeddata', function() {
                    videoLoading.style.display = 'none';
                    playVideo();
                });
                
                heroVideo.addEventListener('error', function(e) {
                    console.error('비디오 로딩 실패:', e);
                    videoLoading.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 비디오 로딩 실패<br><small>대체 이미지를 표시합니다.</small>';
                    
                    setTimeout(() => {
                        videoLoading.style.display = 'none';
                    }, 3000);
                });
                
                document.addEventListener('visibilitychange', function() {
                    if (!document.hidden) {
                        playVideo();
                    }
                });
                
                document.addEventListener('click', function firstClick() {
                    playVideo();
                    document.removeEventListener('click', firstClick);
                });
                
                window.addEventListener('scroll', function() {
                    playVideo();
                });
            }
        }
        
        function playVideo() {
            const heroVideo = document.getElementById('heroVideo');
            if (heroVideo && heroVideo.paused) {
                const playPromise = heroVideo.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('자동 재생 실패:', error);
                    });
                }
            }
        }
        
        function enforceVideoPlayback() {
            const heroVideo = document.getElementById('heroVideo');
            if (heroVideo) {
                heroVideo.muted = true;
                heroVideo.setAttribute('autoplay', '');
                heroVideo.setAttribute('playsinline', '');
                heroVideo.setAttribute('muted', '');
                heroVideo.setAttribute('loop', '');
                heroVideo.style.pointerEvents = 'none';
                
                setTimeout(() => {
                    playVideo();
                }, 100);
            }
        }
        
        // 부드러운 스크롤 (기존 코드)
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                if (this.getAttribute('href') === '#') return;
                
                e.preventDefault();
                
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                
                if (targetElement) {
                    window.scrollTo({
                        top: targetElement.offsetTop - 80,
                        behavior: 'smooth'
                    });
                }
            });
        });
    </script>
</body>
</html>
